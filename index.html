<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Bulk PDF Generator (CSV + ASIN Scraping)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 30px; }
    input, button { margin: 10px 0; }
    .log { margin-top: 20px; font-size: 14px; white-space: pre-wrap; }
  </style>
</head>
<body>

<h2>Bulk PDF Generator (CSV Upload + ASIN Auto Metadata)</h2>

<p><strong>CSV format:</strong></p>
<pre>ASIN,DOWNLOAD_LINK,PDF_NAME</pre>

<input type="file" id="csvFile" accept=".csv" />
<br>
<button onclick="processCSV()">Generate PDFs</button>

<div style="margin-top:15px;">
  <progress id="progressBar" value="0" max="100" style="width:300px;"></progress>
  <span id="progressText">0 / 0</span>
</div>

<div class="log" id="log"></div>

<h3>Generated Output</h3>
<ul id="output"></ul>

<script>
const { jsPDF } = window.jspdf;

async function processCSV() {
  const file = document.getElementById('csvFile').files[0];
  if (!file) return alert('Upload a CSV file');

  const zip = new JSZip();
let total = 0;
let completed = 0;

Papa.parse(file, {
    header: true,
    skipEmptyLines: true,
    complete: async (results) => {
      total = results.data.length;
      document.getElementById('progressBar').max = total;
      document.getElementById('progressText').textContent = `0 / ${total}`;
      for (const row of results.data) {
        await generatePDFfromASIN(row, zip);
        completed++;
        document.getElementById('progressBar').value = completed;
        document.getElementById('progressText').textContent = `${completed} / ${total}`;
      }
      log('DONE: All PDFs generated');
      zip.generateAsync({ type: 'blob' }).then(content => {
        saveAs(content, 'bulk_pdfs.zip');
      });
    }
  });
}

async function generatePDFfromASIN(row, zip) {
  const ASIN = row.ASIN;
  const DOWNLOAD_LINK = row.DOWNLOAD_LINK;
  const PDF_NAME = row.PDF_NAME || ASIN + '.pdf';

  log(`Processing ASIN: ${ASIN}`);

  // AMAZON IMAGE (NO API)
  const coverURL = `https://images-na.ssl-images-amazon.com/images/P/${ASIN}.01._SX1000_.jpg`;

  // METADATA SCRAPING VIA TEXTU.ORG PROXY (NO API KEY)
  const proxyURL = `https://textuploader.net/proxy?url=https://www.amazon.com/dp/${ASIN}`;

  let title = 'Unknown Title';
  let author = 'Unknown Author';
  let status = 'Success';

  try {
    const html = await fetch(proxyURL).then(r => r.text());
    title = extract(html, /<span id="productTitle">([\s\S]*?)<\/span>/);
    author = extract(html, /class="author.*?>(.*?)<\/a>/);
  } catch (e) {
    status = 'Failed';
    log(`Metadata fetch failed for ${ASIN}`);
  }

  const pdf = new jsPDF({ unit: 'pt', format: 'a4' });
  const w = pdf.internal.pageSize.getWidth();
  const h = pdf.internal.pageSize.getHeight();

  // PAGE 1 – COVER
  const img = await loadImage(coverURL);
  pdf.addImage(img, 'JPEG', 0, 0, w, h);

  // PAGE 2 – TEXT
  pdf.addPage();
  pdf.setFontSize(12);

  const text = `Download or Read Online (${title}) free ebook (PDF ePub Mobi) - (${author}) Ebook PDF (${title}) | EBOOK ONLINE DOWNLOAD\n\nIf you want to download a free ebook, you're in the right place. Ebook/PDF (${title}) DOWNLOAD in English is available for free here.\n\nClick on the download LINK below to download the Ebook (${title}) PDF Download in English by (${author}) (Author).`;

  pdf.text(text, 40, 80, { maxWidth: w - 80 });
  pdf.setTextColor(0, 0, 255);
  pdf.textWithLink('DOWNLOAD PDF', 40, 280, { url: DOWNLOAD_LINK });
  pdf.setTextColor(0, 0, 0);

  // PAGES 3–5 BLANK
  pdf.addPage();
  pdf.addPage();
  pdf.addPage();

  const pdfBlob = pdf.output('blob');
  zip.file(PDF_NAME, pdfBlob);

  const li = document.createElement('li');
  li.textContent = `${status} | ${PDF_NAME} | ${title} — ${author}`;
  li.style.color = status === 'Success' ? 'green' : 'red';
  document.getElementById('output').appendChild(li);

  // OUTPUT LIST
  const li = document.createElement('li');
  li.textContent = `Generated: ${PDF_NAME} (ASIN: ${ASIN})`;
  document.getElementById('output').appendChild(li);
}

function extract(html, regex) {
  const match = html.match(regex);
  return match ? match[1].replace(/\s+/g, ' ').trim() : 'Unknown';
}

function loadImage(url) {
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = url;
  });
}

function log(msg) {
  document.getElementById('log').textContent += msg + '\n';
}
</script>

</body>
</html>
